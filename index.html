<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TERRA-VIS // Tactical Terrain Analysis System</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root { --orange: #ff6b35; --green: #4ecdc4; --dark: #0a0e13; --darker: #050709; --panel: #0f1419; --border: #1a2128; --text: #d4dce5; --dim: #5a6673; --red: #ff4757; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--darker); color: var(--text); font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; }
  header { background: var(--dark); border-bottom: 2px solid var(--border); padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-mark { width: 36px; height: 36px; border: 2px solid var(--orange); display: flex; align-items: center; justify-content: center; transform: rotate(45deg); }
  .logo-mark::before { content: ''; width: 16px; height: 16px; background: var(--orange); }
  .logo-text { font-family: 'Share Tech Mono', monospace; font-size: 22px; letter-spacing: 5px; color: var(--orange); }
  .header-stats { display: flex; gap: 40px; }
  .stat-box { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
  .stat-label { font-size: 9px; letter-spacing: 3px; color: var(--dim); text-transform: uppercase; }
  .stat-value { font-family: 'Share Tech Mono', monospace; font-size: 18px; font-weight: 600; color: var(--green); }
  .stat-value.orange { color: var(--orange); }
  main { display: grid; grid-template-columns: 340px 1fr 340px; height: calc(100vh - 64px); gap: 2px; background: var(--border); }
  .panel { background: var(--panel); display: flex; flex-direction: column; }
  .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 11px; letter-spacing: 4px; text-transform: uppercase; color: var(--orange); font-weight: 600; }
  .panel-content { flex: 1; padding: 16px; overflow-y: auto; }
  .section-block { margin-bottom: 24px; }
  .section-title { font-size: 10px; letter-spacing: 3px; color: var(--green); text-transform: uppercase; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
  .mode-buttons { display: flex; gap: 2px; margin-bottom: 12px; }
  .mode-btn { flex: 1; padding: 8px; background: var(--darker); border: 1px solid var(--border); color: var(--dim); font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
  .mode-btn.active { background: var(--orange); color: var(--darker); border-color: var(--orange); }
  .special-btn { width: 100%; margin-bottom: 5px; background: transparent; border: 1px solid var(--green); color: var(--green); padding: 8px; font-size: 10px; letter-spacing: 2px; cursor: pointer; text-transform: uppercase; }
  .special-btn.active { background: var(--green); color: black; box-shadow: 0 0 10px var(--green); }
  .action-btn { width: 100%; padding: 15px; font-weight: bold; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; border: 2px solid; transition: all 0.3s; background: transparent; }
  .action-btn.start { border-color: var(--green); color: var(--green); }
  .action-btn.start:hover { background: var(--green); color: black; box-shadow: 0 0 15px var(--green); }
  .action-btn.stop { border-color: var(--red); color: var(--red); }
  .action-btn.stop:hover { background: var(--red); color: white; box-shadow: 0 0 15px var(--red); }
  .drop-zone { border: 2px dashed var(--border); padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; background: var(--darker); }
  .drop-zone:hover { border-color: var(--orange); }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .webcam-preview { width: 100%; aspect-ratio: 16/9; background: var(--darker); border: 1px solid var(--border); position: relative; overflow: hidden; margin-bottom: 12px; display: flex; align-items: center; justify-content: center;}
  #webcam, #videoPlayer { width: 100%; height: 100%; object-fit: contain; }
  .display-controls { padding: 12px 16px; background: var(--dark); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
  .view-buttons { display: flex; gap: 2px; }
  .view-btn { padding: 6px 12px; background: var(--panel); border: 1px solid var(--border); color: var(--dim); font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
  .view-btn.active { background: var(--green); color: var(--darker); border-color: var(--green); }
  .display-area { flex: 1; display: flex; align-items: center; justify-content: center; background: var(--darker); position: relative; overflow: hidden; }
  #mainDisplay { max-width: 100%; max-height: 100%; object-fit: contain; }
  .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .metric-name { font-size: 11px; letter-spacing: 2px; color: var(--dim); text-transform: uppercase; }
  .metric-val { font-family: 'Share Tech Mono', monospace; font-size: 16px; font-weight: 600; color: var(--green); }
  .iou-item { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
  .iou-header { display: flex; justify-content: space-between; }
  .iou-bar { height: 4px; background: var(--border); overflow: hidden; }
  .iou-fill { height: 100%; background: var(--green); transition: width 0.5s ease; width: 0; }
  .map-container { width: 100%; height: 200px; background: var(--darker); border: 1px solid var(--border); margin-top: 12px; }
  #map { width: 100%; height: 100%; }
  .logs-container { background: var(--darker); border: 1px solid var(--border); padding: 10px; max-height: 120px; overflow-y: auto; font-family: 'Share Tech Mono', monospace; font-size: 10px; line-height: 1.6; margin-top: 12px; }
  .log-entry { color: var(--green); margin-bottom: 2px; }
  .log-entry.error { color: var(--red); }
  .log-entry.warn { color: var(--orange); }
  .threat-panel { border: 1px solid var(--red); background: rgba(255, 0, 0, 0.1); padding: 10px; margin-bottom: 20px; display: none; animation: flash 1s infinite; }
  @keyframes flash { 50% { border-color: transparent; } }
  .env-bar-bg { height: 6px; background: #222; margin-top: 5px; }
  .env-bar-fill { height: 100%; width: 0%; background: var(--green); transition: width 0.5s, background 0.5s; }
</style>
</head>
<body>

<header>
  <div class="logo"><div class="logo-mark"></div><div><div class="logo-text">TERRA-VIS</div><div class="logo-text" style="font-size: 10px; letter-spacing: 2px; color: #5a6673;">TACTICAL TERRAIN ANALYSIS</div></div></div>
  <div class="header-stats">
    <div class="stat-box"><div class="stat-label">Model Accuracy</div><div class="stat-value orange">89.4%</div></div>
    <div class="stat-box"><div class="stat-label">Latency</div><div class="stat-value" id="headerLatency">-- ms</div></div>
    <div class="stat-box"><div class="stat-label">Status</div><div class="stat-value" id="headerStatus">STANDBY</div></div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="panel-header">INPUT CONTROL</div>
    <div class="panel-content">
      <div class="section-block">
        <div class="section-title">Source Select</div>
        <div class="mode-buttons">
          <button class="mode-btn active" id="modeWebcam" onclick="setMode('webcam')">LIVE</button>
          <button class="mode-btn" id="modeVideo" onclick="setMode('video')">VIDEO</button>
          <button class="mode-btn" id="modeStatic" onclick="setMode('static')">FILE</button>
        </div>
        
        <div class="webcam-preview" id="previewBox">
            <video id="webcam" autoplay playsinline muted style="display:none"></video>
            <video id="videoPlayer" loop muted style="display:none"></video>
            <img id="staticPreview" style="display:none; width:100%; height:100%; object-fit:contain;">
            <div id="placeholderText" style="color:var(--dim); font-size:10px;">NO SOURCE</div>
        </div>

        <div id="videoUpload" style="display:none;" class="drop-zone">
            <input type="file" id="videoFile" accept="video/mp4,video/webm" onchange="handleVideo(this)">
            <div style="font-size:10px; color:var(--orange)">SELECT VIDEO FILE (MP4)</div>
        </div>
        <div id="imageUpload" style="display:none;" class="drop-zone">
            <input type="file" id="imageFile" accept="image/*" onchange="handleImage(this)">
            <div style="font-size:10px; color:var(--orange)">SELECT IMAGE FILE</div>
        </div>
      </div>

      <div class="section-block">
        <div class="section-title">Special Sensors (Phase II)</div>
        <button class="special-btn" id="btnDepth" onclick="toggleSpecial('depth')">GHOST VISION (DEPTH)</button>
        <button class="special-btn" id="btnThreat" onclick="toggleSpecial('threat')">TARGET LOCK (YOLO)</button>
      </div>

      <div class="section-block">
        <button id="mainBtn" class="action-btn start" onclick="toggleSystem()">ENGAGE SYSTEMS</button>
      </div>

      <div class="section-block">
        <div class="section-title">System Logs</div>
        <div class="logs-container" id="logsContainer">
          <div class="log-entry">> SYSTEM INITIALIZED</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="display-controls">
      <div class="display-label">VISUAL OUTPUT</div>
      <div class="view-buttons">
        <button class="view-btn active" id="viewSeg" onclick="setView('seg')">SEG</button>
        <button class="view-btn" id="viewRisk" onclick="setView('risk')">RISK</button>
        <button class="view-btn" id="viewPath" onclick="setView('path')">PATH</button>
      </div>
    </div>
    <div class="display-area">
      <img id="mainDisplay" style="display:none; width:100%; height:100%; object-fit:contain;"/>
      <div id="waitText" style="color:var(--dim); font-size:12px; letter-spacing:2px;">AWAITING INFERENCE</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">PERFORMANCE METRICS</div>
    <div class="panel-content">
      
      <div id="threatPanel" class="threat-panel">
          <div class="section-title" style="color:var(--red); border-color:var(--red);">⚠️ THREAT DETECTED</div>
          <div class="metric-row">
              <div class="metric-name" style="color:var(--red);">HOSTILES</div>
              <div class="metric-val" id="valHostiles" style="color:var(--red); font-size: 24px;">0</div>
          </div>
          <div class="metric-row">
              <div class="metric-name" style="color:var(--orange);">VEHICLES</div>
              <div class="metric-val" id="valVehicles" style="color:var(--orange); font-size: 24px;">0</div>
          </div>
      </div>

      <div class="metric-group">
        <div class="section-title">Environmental Risk (Sentinel AI)</div>
        <div class="metric-row">
            <div class="metric-name">Atmosphere</div>
            <div class="metric-val" id="valEnvStatus">CLEAR</div>
        </div>
        <div class="env-bar-bg">
            <div class="env-bar-fill" id="barEnvRisk"></div>
        </div>
        <div style="text-align:right; font-size:10px; color:var(--dim); margin-top:2px;" id="valEnvScore">0%</div>
      </div>

      <div class="metric-group">
        <div class="section-title">Terrain Analysis</div>
        <div class="metric-row"><div class="metric-name">Complexity</div><div class="metric-val" id="metricComplexity">--</div></div>
        <div class="metric-row"><div class="metric-name">Suitability</div><div class="metric-val" id="metricSuitability">--</div></div>
        <div style="font-size:10px; color:var(--dim); margin-top:5px;" id="suitabilityReason"></div>
      </div>

      <div class="metric-group">
        <div class="section-title">Class Distribution</div>
        <div id="iouBars"></div>
      </div>

      <div class="metric-group">
        <div class="section-title">GPS Position</div>
        <div class="metric-row"><div class="metric-name">LAT / LON</div><div class="metric-val" id="metricGPS">-- / --</div></div>
        <div class="map-container"><div id="map"></div></div>
      </div>

      <div class="metric-group">
          <button class="special-btn" onclick="exportReport()" style="border-color:var(--text); color:var(--text);">EXPORT REPORT (PDF/HTML)</button>
      </div>
    </div>
  </div>
</main>

<script>
let map, webcamStream;
let currentMode = 'webcam';
let currentView = 'seg';
let specialMode = 'standard';
let lastData = null;
let isRunning = false;
let mapMarker = null;
let lastHostiles = 0;
let lastVehicles = 0;

window.onload = () => {
    map = L.map('map', { zoomControl: false }).setView([26.9157, 70.9083], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    initBars();
    setMode('webcam');
};

function initBars() {
    const container = document.getElementById('iouBars');
    ['Sky','Sand','Rock','Vegetation','Shadow','Distant'].forEach(c => {
        container.innerHTML += `
            <div class="iou-item">
                <div class="iou-header"><span style="font-size:10px; color:#d4dce5;">${c}</span><span style="font-size:10px; color:var(--orange);" id="val-${c}">0%</span></div>
                <div class="iou-bar"><div class="iou-fill" id="bar-${c}"></div></div>
            </div>`;
    });
}

function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeWebcam').classList.toggle('active', mode === 'webcam');
    document.getElementById('modeVideo').classList.toggle('active', mode === 'video');
    document.getElementById('modeStatic').classList.toggle('active', mode === 'static');
    document.getElementById('videoUpload').style.display = mode === 'video' ? 'block' : 'none';
    document.getElementById('imageUpload').style.display = mode === 'static' ? 'block' : 'none';
    
    const webEl = document.getElementById('webcam');
    const vidEl = document.getElementById('videoPlayer');
    const imgEl = document.getElementById('staticPreview');
    const txtEl = document.getElementById('placeholderText');
    
    webEl.style.display = 'none'; vidEl.style.display = 'none'; imgEl.style.display = 'none';
    
    if(mode === 'webcam') {
        webEl.style.display = 'block'; txtEl.style.display = 'none';
        startWebcam();
    } else {
        stopWebcam();
        if(mode === 'video') vidEl.style.display = 'block';
        if(mode === 'static') imgEl.style.display = 'block';
        txtEl.style.display = 'none';
    }
    log(`SWITCHED TO ${mode.toUpperCase()} MODE`);
}

function startWebcam() {
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        webcamStream = stream;
        document.getElementById('webcam').srcObject = stream;
        log('WEBCAM CONNECTED');
    }).catch(e => log('WEBCAM ERROR', 'error'));
}

function stopWebcam() {
    if(webcamStream) webcamStream.getTracks().forEach(t => t.stop());
}

function handleVideo(input) {
    const file = input.files[0];
    if(file) {
        const url = URL.createObjectURL(file);
        const vid = document.getElementById('videoPlayer');
        vid.src = url;
        vid.play();
        log(`LOADED VIDEO: ${file.name}`);
    }
}

function handleImage(input) {
    const file = input.files[0];
    if(file) {
        const url = URL.createObjectURL(file);
        document.getElementById('staticPreview').src = url;
        log(`LOADED IMAGE: ${file.name}`);
    }
}

function toggleSystem() {
    isRunning = !isRunning;
    const btn = document.getElementById('mainBtn');
    if(isRunning) {
        btn.innerText = "ABORT MISSION";
        btn.className = "action-btn stop";
        document.getElementById('headerStatus').innerText = "ACTIVE";
        document.getElementById('headerStatus').style.color = "var(--green)";
        log("SYSTEM ENGAGED - PROCESSING STARTED");
        loop();
    } else {
        btn.innerText = "ENGAGE SYSTEMS";
        btn.className = "action-btn start";
        document.getElementById('headerStatus').innerText = "STANDBY";
        document.getElementById('headerStatus').style.color = "var(--text)";
        log("SYSTEM HALTED");
    }
}

function toggleSpecial(mode) {
    if (specialMode === mode) {
        specialMode = 'standard';
        document.getElementById('btnDepth').classList.remove('active');
        document.getElementById('btnThreat').classList.remove('active');
    } else {
        specialMode = mode;
        document.getElementById('btnDepth').classList.toggle('active', mode === 'depth');
        document.getElementById('btnThreat').classList.toggle('active', mode === 'threat');
    }
    log(`SENSOR MODE: ${specialMode.toUpperCase()}`);
}

function setView(view) {
    currentView = view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
    if(lastData) updateDisplay(lastData);
}

async function loop() {
    if(!isRunning) return;
    const canvas = document.createElement('canvas');
    let source = null;
    if(currentMode === 'webcam') source = document.getElementById('webcam');
    if(currentMode === 'video') source = document.getElementById('videoPlayer');
    if(currentMode === 'static') source = document.getElementById('staticPreview');
    
    if(!source) return;
    let w, h;
    if(source.tagName === 'VIDEO') { w = source.videoWidth; h = source.videoHeight; }
    else { w = source.naturalWidth; h = source.naturalHeight; }
    
    if(w && h) {
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(source, 0, 0, w, h);
        canvas.toBlob(async blob => {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('mode', specialMode);
            try {
                const res = await fetch('http://localhost:8000/predict', { method: 'POST', body: formData });
                const data = await res.json();
                lastData = data;
                updateDisplay(data);
                updateMetrics(data);
            } catch(e) { console.error(e); }
            if(isRunning) requestAnimationFrame(loop);
        }, 'image/jpeg');
    } else {
        requestAnimationFrame(loop);
    }
}

function updateDisplay(data) {
    const img = document.getElementById('mainDisplay');
    document.getElementById('waitText').style.display = 'none';
    img.style.display = 'block';
    if(specialMode !== 'standard') img.src = "data:image/png;base64," + data.overlay_b64;
    else if(currentView === 'seg') img.src = "data:image/png;base64," + data.overlay_b64;
    else if(currentView === 'risk') img.src = "data:image/png;base64," + data.risk_map_b64;
    else if(currentView === 'path') img.src = "data:image/png;base64," + data.path_plan_b64;
}

function updateMetrics(data) {
    document.getElementById('headerLatency').innerText = data.inference_ms + " ms";
    document.getElementById('metricComplexity').innerText = data.terrain_complexity;
    document.getElementById('metricSuitability').innerText = data.mission_suitability;
    
    if(data.mission_suitability === 'UNSUITABLE') document.getElementById('metricSuitability').style.color = 'var(--red)';
    else if(data.mission_suitability === 'CAUTION') document.getElementById('metricSuitability').style.color = 'var(--orange)';
    else document.getElementById('metricSuitability').style.color = 'var(--green)';
    
    document.getElementById('suitabilityReason').innerText = data.suitability_reason;
    document.getElementById('metricGPS').innerText = data.gps.lat.toFixed(4) + " / " + data.gps.lon.toFixed(4);
    
    const latlng = [data.gps.lat, data.gps.lon];
    map.panTo(latlng);
    if(mapMarker) map.removeLayer(mapMarker);
    mapMarker = L.circleMarker(latlng, { radius: 5, color: '#4ecdc4', fillOpacity: 1 }).addTo(map);
    
    // ENV RISK
    if(data.env_data) {
        const { risk, status } = data.env_data;
        const bar = document.getElementById('barEnvRisk');
        const statEl = document.getElementById('valEnvStatus');
        
        document.getElementById('valEnvScore').innerText = risk + "%";
        statEl.innerText = status;
        bar.style.width = risk + "%";
        
        if(risk > 75) { bar.style.backgroundColor = 'var(--red)'; statEl.style.color = 'var(--red)'; }
        else if(risk > 40) { bar.style.backgroundColor = 'var(--orange)'; statEl.style.color = 'var(--orange)'; }
        else { bar.style.backgroundColor = 'var(--green)'; statEl.style.color = 'var(--green)'; }
    }

    for(const [k, v] of Object.entries(data.iou_per_class)) {
        const pct = (v * 100).toFixed(1);
        const bar = document.getElementById(`bar-${k}`);
        if(bar) {
            bar.style.width = pct + "%";
            document.getElementById(`val-${k}`).innerText = pct + "%";
        }
    }

    if(data.threat_data) {
        const { hostiles, vehicles } = data.threat_data;
        if(hostiles > 0 || vehicles > 0) {
            document.getElementById('threatPanel').style.display = 'block';
            document.getElementById('valHostiles').innerText = hostiles;
            document.getElementById('valVehicles').innerText = vehicles;
            if(hostiles !== lastHostiles || vehicles !== lastVehicles) {
                log(`CONTACT: ${hostiles} HOSTILE(S), ${vehicles} VEHICLE(S)`, 'error');
                lastHostiles = hostiles;
                lastVehicles = vehicles;
            }
        } else {
            document.getElementById('threatPanel').style.display = 'none';
            lastHostiles = 0;
            lastVehicles = 0;
        }
    }
}

function log(msg, type='') {
    const div = document.createElement('div');
    div.className = 'log-entry ' + type;
    div.innerText = '> ' + msg;
    document.getElementById('logsContainer').prepend(div);
}

// RESTORED 'OLD' REPORT GENERATOR (WITH NEW DATA)
function exportReport() {
    if(!lastData) { alert("Run the system first to generate data."); return; }
    const d = new Date();
    
    // Using the original "Box & Grid" layout logic
    const html = `
    <html>
    <head>
        <title>MISSION REPORT</title>
        <style>
            body { font-family: 'Courier New', monospace; background: #f0f0f0; padding: 40px; color: #333; }
            .paper { background: white; max-width: 900px; margin: 0 auto; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid #ff6b35; }
            h1 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; }
            .meta { margin-bottom: 30px; font-size: 14px; border-bottom: 1px dotted #ccc; padding-bottom: 20px; }
            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
            .box { border: 1px solid #ddd; padding: 15px; background: #fafafa; }
            .box h3 { margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 10px; font-size: 14px; color: #555; }
            .img-box img { width: 100%; border: 1px solid #333; height: 250px; object-fit: cover; }
            .stat { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 6px 0; font-size: 13px; }
            .stat:last-child { border-bottom: none; }
            .danger { color: #d32f2f; font-weight: bold; }
            .safe { color: #388e3c; font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="paper">
            <h1>
                <span>TERRA-VIS TACTICAL REPORT</span>
                <span style="font-size:16px; color:#555">#${Date.now().toString().slice(-6)}</span>
            </h1>
            
            <div class="meta">
                <div><strong>DATE:</strong> ${d.toLocaleString()}</div>
                <div><strong>LOCATION:</strong> ${lastData.gps.lat.toFixed(6)}, ${lastData.gps.lon.toFixed(6)}</div>
                <div><strong>MISSION STATUS:</strong> <span class="${lastData.mission_suitability === 'UNSUITABLE' ? 'danger' : 'safe'}">${lastData.mission_suitability}</span></div>
            </div>
            
            <div class="grid">
                <div class="img-box">
                    <h3>SEGMENTATION FEED</h3>
                    <img src="data:image/png;base64,${lastData.overlay_b64}">
                </div>
                <div class="img-box">
                    <h3>RISK ASSESSMENT MAP</h3>
                    <img src="data:image/png;base64,${lastData.risk_map_b64}">
                </div>
            </div>
            
            <div class="grid">
                <div class="box">
                    <h3>TERRAIN COMPOSITION</h3>
                    ${Object.entries(lastData.iou_per_class).map(([k,v]) => 
                        `<div class="stat"><span>${k}</span><span>${(v*100).toFixed(1)}%</span></div>`
                    ).join('')}
                </div>
                <div class="box">
                    <h3>TACTICAL METRICS</h3>
                    <div class="stat"><span>Terrain Complexity</span><span>${lastData.terrain_complexity}/100</span></div>
                    <div class="stat"><span>System Latency</span><span>${lastData.inference_ms} ms</span></div>
                    <div class="stat"><span>Atmospheric Risk</span><span>${lastData.env_data ? lastData.env_data.risk + '%' : 'N/A'} (${lastData.env_data ? lastData.env_data.status : 'N/A'})</span></div>
                    <div class="stat"><span>Detected Hostiles</span><span class="${lastData.threat_data && lastData.threat_data.hostiles > 0 ? 'danger' : ''}">${lastData.threat_data ? lastData.threat_data.hostiles : 0}</span></div>
                    <div class="stat"><span>Detected Vehicles</span><span>${lastData.threat_data ? lastData.threat_data.vehicles : 0}</span></div>
                    <div class="stat"><span>Suitability Reason</span><span>${lastData.suitability_reason}</span></div>
                </div>
            </div>
            
            <div style="text-align: center; font-size: 10px; color: #999; margin-top: 20px;">
                GENERATED BY TERRA-VIS TACTICAL TERRAIN ANALYSIS SYSTEM
            </div>
        </div>
    </body>
    </html>
    `;
    
    const blob = new Blob([html], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TERRA_VIS_REPORT_${Date.now()}.html`;
    a.click();
    log("REPORT DOWNLOADED");
}
</script>
</body>
</html>